// FILE: backend/src/server.ts
// ‚úÖ Dev-safe server.ts
// - No module-alias/register in dev
// - Uses tsconfig-paths/register in nodemon
// - Uses tsc-alias in build (if you run build)
// ------------------------------------------------------------------

import express, { Express, Request, Response, NextFunction } from 'express';
import http from 'http';

// üåê Express app & HTTP server
const app = express();
const server = http.createServer(app);

import { Server as IOServer } from 'socket.io';

// üîå Exported Socket.IO singleton
export let io: IOServer;

import cors from 'cors';
import cookieParser from 'cookie-parser';
import helmet from 'helmet';
import morgan from 'morgan';
import listEndpoints from 'express-list-endpoints';
import mongoose from 'mongoose';
import fs from 'fs';
import path from 'path';
import PDFDocument from 'pdfkit';
import cfgDefault from '@/config';
import * as cfgModule from '@/config';
import { requestLogger } from '@/middlewares/requestLogger';
import { registerAINotifier } from '@/socket/aiNotifier';
import { processJobsSerially } from '@/workers/job.worker';
import { startJudgmentWorker } from '@/controllers/job/startWorker.controller';
import authRoutes from '@/routes/auth.routes';
import judgmentsRoutes from '@/routes/judgments';
import judgmentDownloadRoutes from '@/routes/judgmentDownload';
import superadminRoutes from '@/routes/superadmin';
import nlpRoutes from '@/routes/nlp';
import debugRoutes from '@/routes/debug';
import emailDebugRoutes from '@/routes/debug/email.routes';
import { pricingRoutes } from '@/routes/pricing';
import filesRoutes from '@/routes/files';
import adminFilesRoutes from '@/routes/admin/files';
import enhancedFolderUploadRoutes from '@/routes/admin/enhancedFolderUpload';
import userRoutes from '@/routes/user';
import adminImportRoutes from '@/routes/admin/import';
import judgmentFolderUploadRoutes from '@/routes/admin/judgmentFolderUpload';
import folderProcessorRoutes from '@/routes/admin/folderProcessor';
import legalAnalysisRoutes from '@/routes/admin/legalAnalysis';
import bulkUploadRoutes from '@/routes/admin/bulkUpload';
import dashboardRoutes from '@/routes/dashboard';
import judgmentAuthorizeRoutes from '@/routes/admin/judgmentAuthorize';
import aiLogsRoutes from '@/routes/admin/aiLogs';
import workerLogsRoutes from '@/routes/admin/workerLogs';
import aiRoutes from '@/routes/ai';
import judgmentNLPRoutes from '@/routes/admin/judgmentNLP';

// üîí Auth safety check ‚Äì fail fast if bcrypt is missing
try {
  require('bcrypt');
} catch (err) {
  console.error('‚ùå bcrypt is missing ‚Äì authentication cannot work');
}

