// FILE: backend/src/server.ts
// ‚úÖ Dev-safe server.ts
// - No module-alias/register in dev
// - Uses tsconfig-paths/register in nodemon
// - Uses tsc-alias in build (if you run build)
// ------------------------------------------------------------------

import express, { Express, Request, Response, NextFunction } from 'express';
import http from 'http';

// üåê Express app & HTTP server
const app = express();
const server = http.createServer(app);

import { Server as IOServer } from 'socket.io';

// üîå Exported Socket.IO singleton
export let io: IOServer;

import cors from 'cors';
import cookieParser from 'cookie-parser';
import helmet from 'helmet';
import morgan from 'morgan';
import listEndpoints from 'express-list-endpoints';
import mongoose from 'mongoose';
import fs from 'fs';
import path from 'path';
import PDFDocument from 'pdfkit';
import cfgDefault from '@/config';
import * as cfgModule from '@/config';
import { requestLogger } from '@/middlewares/requestLogger';
import { registerAINotifier } from '@/socket/aiNotifier';
import { processJobsSerially } from '@/workers/job.worker';
import { startJudgmentWorker } from '@/controllers/job/startWorker.controller';
import authRoutes from '@/routes/auth.routes';
import judgmentsRoutes from '@/routes/judgments/judgments.routes';
import judgmentDownloadRoutes from '@/routes/judgmentDownload';
import superadminRoutes from '@/routes/superadmin/superadmin.routes';
import nlpRoutes from '@/routes/nlp/nlp.routes';
import debugRoutes from '@/routes/debug/debug.routes';
import emailDebugRoutes from '@/routes/debug/debug.routes/email.routes';
import { pricingRoutes } from '@/routes/pricing/pricing.routes';
import filesRoutes from '@/routes/files/files.routes';
import adminFilesRoutes from '@/routes/admin/files/files.routes';
import enhancedFolderUploadRoutes from '@/routes/admin/enhancedFolderUpload/enhancedFolderUpload.routes';
import userRoutes from '@/routes/user/user.routes';
import adminImportRoutes from '@/routes/admin/import/import.routes';
import judgmentFolderUploadRoutes from '@/routes/admin/judgmentFolderUpload/judgmentFolderUpload.routes';
import folderProcessorRoutes from '@/routes/admin/folderProcessor/folderProcessor.routes';
import legalAnalysisRoutes from '@/routes/admin/legalAnalysis/legalAnalysis.routes';
import bulkUploadRoutes from '@/routes/admin/bulkUpload/bulkUpload.routes';
import dashboardRoutes from '@/routes/dashboard/dashboard.routes';
import judgmentAuthorizeRoutes from '@/routes/admin/judgmentAuthorize/judgmentAuthorize.routes';
import aiLogsRoutes from '@/routes/admin/aiLogs/aiLogs.routes';
import workerLogsRoutes from '@/routes/admin/workerLogs/workerLogs.routes';
import aiRoutes from '@/routes/ai';
import judgmentNLPRoutes from '@/routes/admin/judgmentNLP/judgmentNLP.routes';

// üîí Auth safety check ‚Äì fail fast if bcrypt is missing
try {
  require('bcrypt');
} catch (err) {
  console.error('‚ùå bcrypt is missing ‚Äì authentication cannot work');
}

